{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}My Orders / ShopEase{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 mb-4">
      {% include 'accounts/includes/sidebar.html' %}
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10">
      <div class="row mb-4 text-center">
        <div class="col-12">
          <h2 class="fw-bold">üõçÔ∏è My Orders</h2>
          <p class="text-muted">View all your past and recent purchases in one place.</p>
          <hr />
        </div>
      </div>

      <!-- Filter Tabs -->
      <ul class="nav nav-pills mb-4 justify-content-center">
        {% for status_data in orders_by_status_list %}
          <li class="nav-item">
            <a class="nav-link {% if forloop.first %}active{% endif %}" 
               data-bs-toggle="pill" href="#{{ status_data.status }}" role="tab">
              {{ status_data.label }}
            </a>
          </li>
        {% endfor %}
      </ul>

      <!-- Tab Content -->
      <div class="tab-content">
        {% for status_data in orders_by_status_list %}
          <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="{{ status_data.status }}" role="tabpanel">
            <div class="row g-4">
              {% if status_data.orders %}
                {% for order in status_data.orders %}
                  <div class="col-12" id="order-card-{{ order.id }}">
                    <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                      <div class="card-header d-flex justify-content-between align-items-center bg-light">
                        <div>
                          <span class="fw-bold">Order #{{ order.id }}</span>
                          <small class="text-muted ms-2">{{ order.created_at|date:"M d, Y ‚Äî h:i A" }}</small>
                        </div>
                        <select class="form-select form-select-sm w-auto" onchange="changeStatus({{ order.id }}, this)">
                          <option value="pending" {% if order.status == "pending" %}selected{% endif %}>Pending</option>
                          <option value="delivered" {% if order.status == "delivered" %}selected{% endif %}>Delivered</option>
                          <option value="cancelled" {% if order.status == "cancelled" %}selected{% endif %}>Cancelled</option>
                        </select>
                      </div>

                      <!-- Products -->
                      <div class="card-body p-4">
                        <div class="row g-3">
                          {% for item in order.items.all %}
                            <div class="col-sm-6 col-md-4 col-lg-3">
                              <div class="card h-100 border-0 shadow-sm rounded-4 hover-shadow">
                                <div class="card-img-container" style="height:180px; overflow:hidden;">
                                  <img src="{% if item.product and item.product.images %}{{ item.product.images.url }}{% else %}{% static 'images/no-image.png' %}{% endif %}" 
                                       class="card-img-top w-100 h-100" 
                                       alt="{{ item.product.name|default:'Product Image' }}" 
                                       style="object-fit: contain;">
                                </div>
                                <div class="card-body text-center d-flex flex-column justify-content-between">
                                  <h6 class="card-title mb-1 text-truncate" title="{{ item.product.name|default:'Unknown Product' }}">{{ item.product.name|default:"Unknown Product" }}</h6>
                                  <p class="text-muted mb-2">{{ item.product.description|truncatewords:10 }}</p>
                                  <div class="d-flex justify-content-between align-items-center">
                                    <span>Qty: <strong>{{ item.quantity }}</strong></span>
                                    <span class="fw-bold text-success">‚Çπ{{ item.product.price|floatformat:2 }}</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          {% endfor %}
                        </div>

                        <!-- Buttons -->
                        <div class="mt-3 d-flex justify-content-center flex-wrap gap-2">
                          <button class="btn btn-outline-primary" onclick="viewProduct({{ order.id }})">
                            <i class="bi bi-eye"></i> View Products
                          </button>
                          <a href="{% url 'update_ordered_product_view' order.items.first.product.id %}" class="btn btn-outline-warning">
                            <i class="bi bi-pencil-square"></i> Update Ordered Product
                          </a>
                          <button class="btn btn-outline-danger" onclick="deleteOrder({{ order.id }})">
                            <i class="bi bi-trash"></i> Delete Order
                          </button>
                        </div>

                        <!-- Order Total -->
                        <div class="d-flex justify-content-end align-items-center mt-3">
                          <h5 class="text-dark mb-0">Order Total: <span class="text-success">‚Çπ{{ order.total_amount|floatformat:2 }}</span></h5>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="col-12 text-center py-5 no-orders">
                  <img src="{% static 'images/empty-orders.png' %}" alt="No Orders" width="150" class="mb-3">
                  <h5 class="text-muted">No orders found.</h5>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
  <div id="statusToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">Action completed successfully!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel">Products</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="productModalBody" style="max-height:70vh; overflow-y:auto;"></div>
    </div>
  </div>
</div>

<script>
/* ====================== Helpers ====================== */
function showToast(msg, type='success'){
    const toastEl = document.getElementById('statusToast');
    const toastBody = document.getElementById('toastMessage');
    toastBody.textContent = msg;
    toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
    new bootstrap.Toast(toastEl).show();
}

function getCSRFToken(){
    let cookieValue = null;
    if(document.cookie){
        document.cookie.split(';').forEach(cookie => {
            cookie = cookie.trim();
            if(cookie.startsWith('csrftoken=')) cookieValue = decodeURIComponent(cookie.substring(10));
        });
    }
    return cookieValue;
}

/* ====================== Tabs Persistence ====================== */
document.querySelectorAll('a[data-bs-toggle="pill"]').forEach(link => {
    link.addEventListener('shown.bs.tab', (e) => localStorage.setItem('activeOrderTab', e.target.getAttribute('href')));
});
document.addEventListener('DOMContentLoaded', () => {
    const activeTab = localStorage.getItem('activeOrderTab');
    if(activeTab){
        const tabEl = document.querySelector(`a[href="${activeTab}"]`);
        if(tabEl) new bootstrap.Tab(tabEl).show();
    }
});

/* ====================== Status Update ====================== */
function changeStatus(orderId, selectElem){
    fetch(`/orders/update-status/${orderId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({status: selectElem.value})
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            showToast(`Order #${orderId} status updated`);
            moveOrderToTab(orderId, selectElem.value);
        } else showToast('Failed to update status', 'danger');
    }).catch(()=>showToast('Something went wrong!', 'danger'));
}

/* ====================== Delete Order ====================== */
function deleteOrder(orderId){
    if(!confirm(`Delete order #${orderId}?`)) return;
    fetch(`/orders/delete/${orderId}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': getCSRFToken()}
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            showToast(`Order #${orderId} deleted`);
            removeOrderFromTab(orderId);
        } else showToast(data.error, 'danger');
    }).catch(()=>showToast('Something went wrong!', 'danger'));
}

/* ====================== DOM Manipulation ====================== */
function moveOrderToTab(orderId, newStatus){
    const card = document.getElementById(`order-card-${orderId}`);
    const oldRow = card.closest('.row.g-4');
    const targetRow = document.getElementById(newStatus).querySelector('.row.g-4');
    if(card && targetRow){
        targetRow.querySelector('.no-orders')?.remove();
        targetRow.prepend(card);
        if(oldRow.children.length === 0){
            oldRow.innerHTML = `<div class="col-12 text-center py-5 no-orders">
                <img src="{% static 'images/empty-orders.png' %}" width="150" class="mb-3">
                <h5 class="text-muted">No orders found.</h5></div>`;
        }
    }
}

function removeOrderFromTab(orderId){
    const card = document.getElementById(`order-card-${orderId}`);
    const row = card.closest('.row.g-4');
    card.remove();
    if(row.children.length === 0){
        row.innerHTML = `<div class="col-12 text-center py-5 no-orders">
            <img src="{% static 'images/empty-orders.png' %}" width="150" class="mb-3">
            <h5 class="text-muted">No orders found.</h5></div>`;
    }
}

/* ====================== Product Modal ====================== */
function viewProduct(orderId){
    const modalBody = document.getElementById('productModalBody');
    modalBody.innerHTML = `<p class="text-center text-muted my-3">Loading products for Order ID: <strong>${orderId}</strong>...</p>`;
    new bootstrap.Modal(document.getElementById('productModal')).show();

    fetch(`/orders/order-products/${orderId}/`)
    .then(res => res.json())
    .then(data => {
        if(!data.products || data.products.length === 0){
            modalBody.innerHTML = '<p class="text-center text-muted my-3">No products found for this order.</p>';
            return;
        }

        let html = '<div class="row g-4">';
        data.products.forEach(p => {
            html += `
            <div class="col-sm-6 col-md-4 col-lg-3">
                <div class="card h-100 border-0 shadow-sm rounded-4 hover-shadow">
                    <div class="card-img-container" style="height:180px; overflow:hidden;">
                        <img src="${p.image_url}" class="card-img-top w-100 h-100" style="object-fit: contain;">
                    </div>
                    <div class="card-body text-center d-flex flex-column justify-content-between">
                        <h6 class="card-title mb-2 text-truncate" title="${p.name}">${p.name}</h6>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span class="badge bg-light text-dark">Qty: <strong>${p.quantity}</strong></span>
                            <span class="badge bg-success text-white">‚Çπ${p.price.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        html += '</div>';
        modalBody.innerHTML = html;
    })
    .catch(err => {
        console.error(err);
        modalBody.innerHTML = '<p class="text-center text-danger my-3">Failed to load products.</p>';
    });
}
</script>

<style>
.hover-shadow:hover { transform: translateY(-5px); transition: all 0.3s ease; box-shadow: 0 15px 25px rgba(0,0,0,0.2) !important; }
.card-body h6 { font-size: 0.95rem; }
.card-body p { font-size: 0.85rem; }
.btn-outline-primary, .btn-outline-warning, .btn-outline-danger { font-weight: 500; border-width: 2px; transition: all 0.3s ease; }
.btn-outline-primary:hover { background-color: #0d6efd; color: white; }
.btn-outline-warning:hover { background-color: #ffc107; color: black; }
.btn-outline-danger:hover { background-color: #dc3545; color: white; }
</style>
{% endblock %}
